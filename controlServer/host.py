from flask import Flask
from flask import jsonify
from flask import request
from flask_cors import CORS
import os

app = Flask(__name__)
CORS(app)

commands = {}

#TODO: change env variable PRIMARY_VM when your clone isn't killed by malware

@app.route('/fork_vm', methods=['POST'])
def fork_vm():
    #ip_addr = request.args.get('ip_addr', None)
    #command = request.args.get('command', None)
    fork_data = {}
    fork_data["ip_addr"] = request.remote_addr
    fork_data["command"] = request.form["command"]
    fork_data["pwd"] = request.form["pwd"]
    fork_data["user"] = request.form["user"]

    if ip_addr is None or command is None:
        return jsonify({'success': False})

    # write cloning stuff here
    os.system("./createClone")
    os.system("source $PWD/export_ip")
    new_ip_addr = os.environ["CLONED_VM_IP"]
    commands[new_ip_addr] = fork_data


@app.route('/get_command', methods=['GET'])
def get_command():
    ip_addr = request.args.get('ip_addr', None)
    command = commands.get(ip_addr, None)
    
    if ip_addr is None or command is None:
        return jsonify({'success': False})

    del commands[ip_addr]
    return command


app.run(host='0.0.0.0', port=8000, threaded=True, debug=True)
