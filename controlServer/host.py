from flask import Flask
from flask import jsonify
from flask import request
from flask_cors import CORS
import os
import threading
from paramiko import SSHClient, AuthenticationException, AutoAddPolicy
import time
import json

app = Flask(__name__)
CORS(app)


olog = None
clog = None

origin_updated = False
clone_updated = False

status = {
    'clone_ip': None,
    'high_cpu': False,
    'high_mem': False,
    'high_disk': False,
    'high_network': False,
    'ssh_access': True,
    'new_users_added': False,
    'new_ports_opened': False
}

def threshold_status_setter(log_key, status_key, threshold):
    global clog, olog
    if olog[log_key] != 0:
        status[status_key] = clog[log_key] / olog[log_key] >= threshold

def compare_status_setter(log_key, status_key):
    global clog, olog
    status[status_key] = clog[log_key] != olog[log_key]

def analyze():
    threshold_status_setter('cpu', 'high_cpu', 1.5)
    threshold_status_setter('mem', 'high_mem', 1.3)
    threshold_status_setter('net', 'high_network', 2)
    threshold_status_setter('disk', 'high_disk', 2)

    compare_status_setter('users', 'new_users_added')
    compare_status_setter('ports', 'new_ports_opened')

def get_clone_ip():
    try:
        new_ip_addr = open("export_ip", "r").read().strip().split("/")[0]
        if is_ssh_server_up(new_ip_addr):
           return new_ip_addr
        else:
            print('clone is dead')
            open('export_ip', 'w').close()
            return None
     
    except:
        return None

@app.route('/fork_vm', methods=['POST'])
def fork_vm():

    fork_data = request.get_json()
    print(fork_data)
    ip_addr = request.remote_addr
    command = fork_data.get('command', None)

    with open('command', 'w') as cmd_file:
        json.dump(fork_data, cmd_file)

    if ip_addr is None or command is None:
        return jsonify({'success': False})

    # write cloning stuff here
    os.system("sh /home/alok/foolMalware/createClone")
    new_ip_addr = get_clone_ip()

    status['clone_ip'] = new_ip_addr

    

    return jsonify({"status": "cloned successfully!"})


@app.route('/get_command', methods=['GET'])
def get_command():
    ip_addr = request.remote_addr
    print(repr(ip_addr))
    print(repr(status['clone_ip']))
    if ip_addr == status['clone_ip']:
        try:
            with open('command') as cmd_file:
                payload = json.load(cmd_file)
            open('command', 'w').close()
            print(ip_addr, payload)
            return jsonify(payload)
        except Exception as e:
            print(e)
    return jsonify({'success': False})

@app.route('/log', methods=['POST'])
def log():
    global clog, olog, clone_updated, origin_updated
    data = request.get_json()
    ip_addr = request.remote_addr
    if status['clone_ip'] is None:
        return jsonify({'success': True})

    if ip_addr == status['clone_ip']:
        clog = data
        clog['ports'] = set(clog['ports'])
        clog['users'] = set(clog['users'])
        clone_updated = True
    else:
        olog = data
        olog['ports'] = set(olog['ports'])
        olog['users'] = set(olog['users'])
        origin_updated = True

    if origin_updated and clone_updated:
        origin_updated = False
        clone_updated = False
        analyze()

    return jsonify({'success': True})


@app.route('/status', methods=['GET'])
def get_status():
    return jsonify(status)


def is_ssh_server_up(ip):
    try:
        ssh = SSHClient()
        ssh.set_missing_host_key_policy(AutoAddPolicy())
        ssh.connect(ip, username='__fakeuser__qwertyuiop__0123456789__')
    except AuthenticationException as e:
        return True
    except Exception as e:
        print(e)
        return False


def monitor_ssh():
    while True:
        time.sleep(5)

        if status['clone_ip'] is None:
            continue

        status['ssh_access'] = is_ssh_server_up(status['clone_ip'])


def main():
    status['clone_ip'] = get_clone_ip()
    app.run(host='0.0.0.0', port=8000, threaded=True, debug=True)
    thread = threading.Thread(target=monitor_ssh)
    thread.start()

if __name__ == '__main__':
    main()
